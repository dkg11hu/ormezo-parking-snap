PORT ?= 3000
PIDFILE ?= server.pid
LOGFILE ?= server.log

.PHONY: start-service stop-service restart-service run-extractor run-extractor-verbose

# Start server in background (nohup) and write PID
start-service:
    @echo "Starting server in background (logs -> $(LOGFILE))..."
    @nohup node server.js > $(LOGFILE) 2>&1 & echo $$! > $(PIDFILE)
    @echo "Started with PID $$(cat $(PIDFILE))"

# Stop by PID file if present, otherwise fall back to lsof
stop-service:
    @echo "Stopping server on port $(PORT) ..."
    @if [ -f "$(PIDFILE)" ]; then \
      PID=$$(cat $(PIDFILE)); \
      echo "Killing PID $$PID"; \
      kill $$PID && rm -f $(PIDFILE) || (echo "Failed to kill $$PID"; exit 1); \
    else \
      echo "No PID file; falling back to lsof lookup"; \
      lsof -iTCP:$(PORT) -sTCP:LISTEN -Pn -t || true; \
      lsof -iTCP:$(PORT) -sTCP:LISTEN -Pn -t | xargs -r kill || true; \
    fi

restart-service: stop-service start-service

run-extractor:
    @echo "Running extractor and showing first 200 lines of output..."
    @time node extractor.js 2>&1 | sed -n '1,200p' || true
    @echo
    @echo "Listing parking-status.json (if present):"
    @ls -l parking-status.json || true
    @echo
    @echo "Show first 400 bytes of parking-status.json:"
    @head -c 400 parking-status.json || true
    @echo
    @echo "Validate JSON with jq (if installed):"
    @jq . parking-status.json | sed -n '1,40p' || true

run-extractor-verbose:
    @echo "Running extractor (verbose) ..."
    @start=$$(date +%s); node extractor.js 2>&1 | tee extractor.log; rc=$$?; end=$$(date +%s); echo "Exit code: $$rc, duration: $$((end-start))s"; exit $$rc
