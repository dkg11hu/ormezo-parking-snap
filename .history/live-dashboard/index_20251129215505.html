<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>P+R Parkoló Foglaltság</title>
  <style>
    :root{
      --bg:#ffffff; --muted:#6b7280; --accent:#0f766e; --danger:#dc2626;
      --card:#f8fafc; --bar-bg:#e6eef0; --fill:#10b981; --gap:12px;
      --radius:10px; --pad:12px;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:#0f172a;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    .wrap{max-width:420px;margin:0 auto;padding:16px;}
    header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:12px;}
    h1{font-size:1.05rem;margin:0;line-height:1.1}
    .meta{font-size:0.85rem;color:var(--muted);margin-top:4px}
    #controls{display:flex;gap:8px;align-items:center}
    button{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;font-size:0.95rem;cursor:pointer}
    button[disabled]{opacity:.6;cursor:default}
    .status{font-size:0.85rem;color:var(--muted)}
    main{display:grid;gap:12px}
    .card{background:var(--card);border-radius:var(--radius);padding:var(--pad);box-shadow:0 1px 2px rgba(2,6,23,0.06);display:flex;flex-direction:column;gap:8px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .label{font-weight:600;font-size:0.98rem}
    .numbers{display:flex;flex-direction:column;align-items:flex-end;min-width:86px}
    .count{font-size:1.05rem;font-weight:700}
    .total{font-size:0.85rem;color:var(--muted)}
    .bar-wrap{width:100%;display:flex;align-items:center;gap:8px}
    .bar{flex:1;height:12px;background:var(--bar-bg);border-radius:8px;overflow:hidden}
    .fill{height:100%;background:var(--fill);transition:width .4s ease}
    .low .fill{background:var(--danger)}
    .timestamp{font-size:0.82rem;color:var(--muted);text-align:right}
    footer{margin-top:14px;font-size:0.82rem;color:var(--muted);text-align:center}
    /* Larger screens show table-like layout */
    @media(min-width:420px){
      .wrap{padding:20px}
      .card{flex-direction:row;align-items:center}
      .bar-wrap{max-width:320px}
      .numbers{align-items:flex-end}
    }
  </style>
</head>
<body>
  <div class="wrap" role="main">
    <header>
      <div>
        <h1>P+R Parkoló Foglaltság</h1>
        <div class="meta" id="last-updated">Frissítve: —</div>
      </div>
      <div id="controls">
        <button id="refreshBtn" aria-label="Frissítés">Frissít</button>
        <div class="status" id="status">—</div>
      </div>
    </header>

    <main id="list" aria-live="polite">
      <!-- cards injected here -->
    </main>

    <footer>
      Az oldal automatikusan frissül 5 percenként. Ha nem látsz friss adatot, nyomd meg a Frissít gombot.
    </footer>
  </div>

  <script>
    const API = '/parking-status.json';
    const REFRESH_MS = 300000; // 5 minutes
    const list = document.getElementById('list');
    const lastUpdated = document.getElementById('last-updated');
    const status = document.getElementById('status');
    const refreshBtn = document.getElementById('refreshBtn');

    function formatPct(free, total) {
      if (!total) return '0%';
      return (free / total * 100).toFixed(1) + '%';
    }

    function createCard(item) {
      const pct = item.total ? (item.free / item.total * 100) : 0;
      const card = document.createElement('article');
      card.className = 'card' + (pct < 20 ? ' low' : '');
      card.setAttribute('role','article');
      card.innerHTML = `
        <div style="flex:1">
          <div class="label">${escapeHtml(item.label)}</div>
          <div class="bar-wrap" aria-hidden="true" style="margin-top:8px">
            <div class="bar" title="Szabad: ${item.free}/${item.total} (${pct.toFixed(1)}%)">
              <div class="fill" style="width:${pct.toFixed(2)}%"></div>
            </div>
            <div style="min-width:56px;text-align:right;font-size:0.9rem;color:var(--muted)">${pct.toFixed(1)}%</div>
          </div>
        </div>
        <div class="numbers" aria-hidden="false">
          <div class="count">${item.free}</div>
          <div class="total">/${item.total}</div>
          <div class="timestamp" style="margin-top:6px">${escapeHtml(item.updated)}</div>
        </div>
      `;
      return card;
    }

    function render(data) {
      // sort by free descending
      data.sort((a,b) => (b.free||0) - (a.free||0));
      list.innerHTML = '';
      data.forEach(it => list.appendChild(createCard(it)));
      lastUpdated.textContent = 'Frissítve: ' + (data[0]?.updated || new Date().toISOString());
    }

    async function fetchAndRender() {
      status.textContent = 'Betöltés…';
      refreshBtn.disabled = true;
      try {
        const res = await fetch(API, { cache: 'no-store' });
        if (!res.ok) throw new Error('Hálózati hiba');
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error('Váratlan formátum');
        render(data);
        status.textContent = 'OK';
      } catch (err) {
        console.error(err);
        status.textContent = 'Hiba';
      } finally {
        refreshBtn.disabled = false;
      }
    }

    // small HTML escape
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // initial load on DOM ready
    document.addEventListener('DOMContentLoaded', () => {
      fetchAndRender();
      setInterval(fetchAndRender, REFRESH_MS);
    });

    // manual refresh
    refreshBtn.addEventListener('click', fetchAndRender);

    // allow pull-to-refresh on iOS Safari by reloading when user scrolls to top and pulls (optional)
    let touchStartY = 0;
    window.addEventListener('touchstart', e => { if (window.scrollY === 0) touchStartY = e.touches[0].clientY; });
    window.addEventListener('touchend', e => {
      const dy = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0].clientY - touchStartY : 0;
      if (dy > 80) fetchAndRender();
    });
  </script>
</body>
</html>
