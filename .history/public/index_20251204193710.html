<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Parkoló státusz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="./icons/favicon-192.png">
  <style>
    body { font-family: system-ui, sans-serif; background:#f7f7f8; margin:0; padding:20px; }
    h1 { font-size:1.2rem; margin-bottom:0.25rem; }
    .meta { color:#666; font-size:0.9rem; margin-bottom:1rem; }

    .grid { display:grid; gap:12px; }
    @media (orientation:portrait) { .grid { grid-template-columns:1fr; grid-template-rows:repeat(4,auto); } }
    @media (orientation:landscape) { .grid { grid-template-columns:1fr 1fr; grid-template-rows:repeat(2,auto); } }

    .card { background:#fff; padding:12px; border-radius:10px; box-shadow:0 1px 3px rgba(0,0,0,0.1); display:flex; justify-content:space-between; align-items:center; }
    .label { font-weight:600; margin-bottom:6px; }
    .bar-wrap { display:flex; gap:8px; align-items:center; }
    .bar { background:#eef2f4; height:12px; width:160px; border-radius:8px; overflow:hidden; }
    .fill { height:100%; background:linear-gradient(90deg,#2ea44f,#1b8f3a); }
    .pct { min-width:40px; text-align:right; font-size:0.9rem; color:#666; }
    .numbers { text-align:right; min-width:84px; display:flex; flex-direction:column; gap:4px; }
    .count { font-weight:700; font-size:1rem; }
    .total { color:#666; font-size:0.9rem; }
    .timestamp { color:#999; font-size:0.8rem; }
    .details { margin-top:4px; font-size:0.8rem; }
    .details a { color:#0066cc; text-decoration:none; }
    .details a:hover { text-decoration:underline; }
  </style>
</head>
<body>
  <h1>Parkoló státusz</h1>
  <div id="report-time" class="meta"></div>
  <main id="parking-grid" class="grid"></main>

<script>
  function timeDiffString(updated) {
    const now = new Date();
    const upd = new Date(updated.replace(" ", "T"));
    const diffMs = now - upd;
    const diffMin = Math.floor(diffMs / 60000);
    if (diffMin < 1) return "épp most";
    if (diffMin < 60) return diffMin + " perce";
    const diffH = Math.floor(diffMin / 60);
    if (diffH < 24) return diffH + " órája";
    const diffD = Math.floor(diffH / 24);
    return diffD + " napja";
  }

  async function refreshParkingStatus() {
    try {
      const statusRes = await fetch("parking-status.json?ts=" + Date.now());
      const statusData = await statusRes.json();

      const urlsRes = await fetch("urls.json?ts=" + Date.now());
      const urlsData = await urlsRes.json();

      const grid = document.getElementById("parking-grid");
      grid.innerHTML = "";

      const reportTime = new Date();
      document.getElementById("report-time").textContent =
        "Jelentés ideje: " + reportTime.toLocaleString("hu-HU");

      statusData.forEach(entry => {
        const percent = Math.round((entry.free / entry.total) * 100);
        const relative = timeDiffString(entry.updated);

        // keresd meg a urls.json-ben a megfelelő url-t az id alapján
        const urlEntry = urlsData.find(u => u.label === entry.label || u.id === entry.id);
        const detailUrl = urlEntry ? urlEntry.url : "#";

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="left">
            <div class="label">${entry.label}</div>
            <div class="bar-wrap">
              <div class="bar">
                <div class="fill" style="width:${percent}%"></div>
              </div>
              <div class="pct">${percent}%</div>
            </div>
          </div>
          <div class="numbers">
            <div class="count">${entry.free}</div>
            <div class="total">/${entry.total}</div>
            <div class="timestamp">${relative}</div>
            <div class="details"><a href="${detailUrl}" target="_blank">Részletek</a></div>
          </div>
        `;
        grid.appendChild(card);
      });
    } catch (err) {
      console.error("Hiba a JSON betöltésekor:", err);
    }
  }

  window.onload = () => {
    refreshParkingStatus();
    setInterval(refreshParkingStatus, 60000); // frissítés 60 másodpercenként
  };
</script>
</body>
</html>
